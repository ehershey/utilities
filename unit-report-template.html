<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta name="generator" content=
  "HTML Tidy for Linux (vers 14 June 2007), see www.w3.org">
  <style type="text/css">
    .right {{
        float: right;
    }}
    .left {{
        float: left;
    }}
    table,body {{
        width: 100%;
        font-size: 32pt;
    }}
table,tr,td,th {{
        border: 1px solid black;
        padding: 5px;
    }}
    .positive_diff {{
        background: green;
        color: white;
    }}
    .negative_diff {{
        background: red;
        color: black;
    }}
    .comparitor {{
        font-weight: bold;
    }}
  </style>
  <title></title>
</head>
<body>
  <table summary="Averages and differences" cellpadding='0'
  cellspacing='0'>
    <tr>
      <th>What</th>
      <th>Value</th>
      <th>Vs. 2014</th>
      <th>Vs. 2013</th>
    </tr>
    <tr class="{surplus_class}">
      <td>Surplus:</td>
      <td>{surplus_today}</td>
      <td class="comparitor">{surplus_today_2014_diff}</td>
      <td>&nbsp;</td>
    </tr>
    <tr class="{surplus_2days_class}">
      <td>Surplus over 2 days:</td>
      <td>{surplus_2days}</td>
      <td class="comparitor">{surplus_2days_2014_diff}</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td>Surplus Yesterday:</td>
      <td>{surplus_yesterday}</td>
      <td class="comparitor">{surplus_yesterday_2014_diff}</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td>2014 Surplus (average):</td>
      <td>{surplus_2014}</td>
      <td>&nbsp;</td>
      <td>&nbsp;</td>
    </tr>
    <tr class="{surplus_2016_class}">
      <td>2016 Surplus (average):</td>
      <td>{surplus_2016}</td>
      <td class="compatitor">{surplus_2016_2014_diff}</td>
      <td>&nbsp;</td>
    </tr>

    <tr class="{today_class}">
      <td>Today:</td>
      <td>{units_today}</td>
      <td>{units_today_2014_diff}</td>
      <td class="comparitor">{units_today_2013_diff}</td>
    </tr>
    <tr class="{2days_class}">
      <td>Last 2 days:</td>
      <td>{units_average_2days}</td>
      <td>{units_average_2days_2014_diff}</td>
      <td class="comparitor">{units_average_2days_2013_diff}</td>
    </tr>
    <tr>
      <td>Yesterday:</td>
      <td>{units_yesterday}</td>
      <td>{units_yesterday_2014_diff}</td>
      <td>{units_yesterday_2013_diff}</td>
    </tr>
    <tr class="{alltime_class}">
      <td>Alltime Average:</td>
      <td>{units_average}</td>
      <td>{units_average_2014_diff}</td>
      <td class="comparitor">{units_average_2013_diff}</td>
    </tr>
    <tr>
      <td>2014 Average:</td>
      <td>{units_average_2014}</td>
      <td>&nbsp;</td>
      <td>{units_average_2014_2013_diff}</td>
    </tr>
    <tr class="{7days_class}">
      <td>Last 7 days:</td>
      <td>{units_average_7days}</td>
      <td>{units_average_7days_2014_diff}</td>
      <td class="comparitor">{units_average_7days_2013_diff}</td>
    </tr>
    <tr class="{input_class}">
      <td><a href="{input_today_url}">Input:</a></td>
      <td><a href="{input_today_url}">{input_today}</a></td>
      <td class="comparitor">{input_today_2014_diff}</td>
      <td>{input_today_2013_diff}</td>
    </tr>
    <tr>
      <td><a href="{input_yesterday_url}">Input Yesterday:</a></td>
      <td><a href="{input_yesterday_url}">{input_yesterday}</a></td>
      <td>{input_yesterday_2014_diff}</td>
      <td>{input_yesterday_2013_diff}</td>
    </tr>
    <tr>
      <td>2014 Input:</td>
      <td>{input_2014}</td>
      <td>&nbsp;</td>
      <td>{input_2014_2013_diff}</td>
    </tr>
   <tr>
      <td>2016 Surplus (cumulative):</td>
      <td>{surplus_2016_total}</td>
      <td>&nbsp;</td>
      <td>&nbsp;</td>
    </tr>
 </table><br>
  <br>
  <table summary="Timestamp information" cellpadding='0'
  cellspacing='0'>
    <tr>
      <td>HTML generated:</td>
      <td><!--diffignore-->{now} (<span id="html_age"></span>)</td>
    </tr>
    <tr>
      <td>Moves data updated:</td>
      <td>{moves_csv_modified} (<span id="moves_age"></span>)</td>
    </tr>
  </table>
  <a class="left" href="?">Refresh</a>
  <a class="right" href="moves://">Launch Moves App</a><br/>
  <script type="text/javascript">
    var request = new XMLHttpRequest();
    var request_running = false;
    var last_new_data_age_seconds = 0;

    request.onreadystatechange = function () {{
      var DONE = this.DONE || 4;
      if (this.readyState === DONE) {{
        request_running = false;
        console.log('got response');
        var new_data_timestamp = this.getResponseHeader('last-modified');
        if(new_data_timestamp) {{
        console.log('got timestamp');
          var new_data_date = new Date(new_data_timestamp);
          var now = new Date();
          var new_data_age_seconds = ( now - new_data_date ) / 1000;
          console.log('new data age: ' + new_data_age_seconds);
          console.log('last new data age: ' + last_new_data_age_seconds);

          // if the age fo the file on the server ever drops, it means
          // it's newer than what we're currently viewing, so refresh
          //
          if(new_data_age_seconds < last_new_data_age_seconds) {{
            document.location.href = get_new_self_url();
          }}
          last_new_data_age_seconds = new_data_age_seconds;
        }}
        else console.log('did not get timestamp');
      }}
      else console.log('did not get done ready state');
    }};

    setInterval(function() {{
      document.getElementById("html_age").innerHTML = get_date_age("{now}"); // diffignore (ignore comparing against previous html)
      document.getElementById("moves_age").innerHTML = get_date_age("{moves_csv_modified}");
      if(!request_running) {{
      console.log('request not running');
        request_running = true;
        request.open('GET', get_new_self_url(), true);

        // Tells server that this call is made for ajax purposes.
        // Most libraries like jQuery/Prototype/Dojo do this
        //
        request.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        request.send(null);  // No data needs to be sent along with the request.
      }}
      else console.log('request already running');



    }}, 1000);

    // Double curly brace everywhere for python templating
    //
    function get_date_age(date_string)
    {{
      var return_string = '';
      var old_date = new Date(date_string);
      var now = new Date();
      var diff_ms = now - old_date;
      var diff_s = Math.floor(diff_ms / 1000);
      var diff_m = Math.floor(diff_s / 60);
      var diff_h = Math.floor(diff_m / 60);
      var diff_d = Math.floor(diff_h / 24);

      diff_s = diff_s % 60;
      diff_m = diff_m % 60;
      diff_h = diff_h % 24;

      if(diff_d) if(return_string) return_string += ', ';
      if(diff_d) return_string += diff_d + ' day';
      if(diff_d && diff_d > 1) return_string += 's';
      if(diff_h) if(return_string) return_string += ', ';
      if(diff_h) return_string += diff_h + ' hour';
      if(diff_h && diff_h > 1) return_string += 's';
      if(diff_m) if(return_string) return_string += ', ';
      if(diff_m) return_string += diff_m + ' minute';
      if(diff_m && diff_m > 1) return_string += 's';
      if(diff_s) if(return_string) return_string += ', ';
      if(diff_s) return_string += diff_s + ' second';
      if(diff_s && diff_s > 1) return_string += 's';
      return return_string;
    }}

    function get_new_self_url()
    {{
      var now = new Date();
      return document.location.href.replace(/\?.*/,'') + '?loaded_at=' + escape(now);
    }}

  </script>
</body>
</html>
